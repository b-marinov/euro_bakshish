name: Docker Tests

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'Dockerfile*'
      - 'docker-compose*.yml'
      - '.dockerignore'
      - '.github/workflows/docker-tests.yml'
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'Dockerfile*'
      - 'docker-compose*.yml'
      - '.dockerignore'
      - '.github/workflows/docker-tests.yml'

permissions:
  contents: read

jobs:
  docker-validation:
    name: Validate Docker Configuration
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Validate docker-compose.yml
      run: |
        docker compose -f docker-compose.yml config

    - name: Validate docker-compose.dev.yml
      run: |
        docker compose -f docker-compose.dev.yml config

    - name: Validate docker-compose.test.yml
      run: |
        docker compose -f docker-compose.test.yml config

    - name: Build production Docker image
      run: |
        docker build -t euro_bakshish:test .

    - name: Build development Docker image
      run: |
        docker build -f Dockerfile.dev -t euro_bakshish:dev .

    - name: Build test Docker image
      run: |
        docker build -f Dockerfile.test -t euro_bakshish:test-img .

    - name: Test image size (production)
      run: |
        docker images euro_bakshish:test --format "{{.Size}}"
        # Check that image is not unreasonably large (< 2GB)
        size=$(docker images euro_bakshish:test --format "{{.Size}}" | grep -oE '[0-9.]+')
        echo "Image size: ${size}"

    - name: Run production container smoke test
      run: |
        # Start the container in detached mode
        docker run -d \
          --name euro_bakshish_test \
          -p 3000:3000 \
          -p 8000:8000 \
          -e DATABASE_URL=sqlite:///./data/euro_bakshish.db \
          euro_bakshish:test

        # Wait for container to start
        echo "Waiting for container to be ready..."
        sleep 45

        # Check if container is still running
        if ! docker ps | grep -q euro_bakshish_test; then
          echo "Container exited unexpectedly"
          docker logs euro_bakshish_test
          exit 1
        fi

        echo "Container is running successfully"
        docker logs euro_bakshish_test

        # Cleanup
        docker stop euro_bakshish_test
        docker rm euro_bakshish_test

  docker-compose-tests:
    name: Docker Compose Tests
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'

    - name: Install test dependencies
      run: |
        pip install pytest pytest-cov

    - name: Run Docker-specific tests
      run: |
        # Run only docker marker tests
        pytest tests/test_docker.py -v -m docker

  docker-test-runner:
    name: Run Tests in Docker
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Build test image
      run: |
        docker compose -f docker-compose.test.yml build

    - name: Run tests in Docker
      run: |
        docker compose -f docker-compose.test.yml run --rm euro_bakshish_test

    - name: Cleanup
      if: always()
      run: |
        docker compose -f docker-compose.test.yml down -v
