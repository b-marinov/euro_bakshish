name: Docker Build and Test

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'backend/**'
      - 'web/**'
      - 'docker-compose*.yml'
      - '.github/workflows/docker-tests.yml'
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'backend/**'
      - 'web/**'
      - 'docker-compose*.yml'
      - '.github/workflows/docker-tests.yml'

jobs:
  docker-build-and-test:
    name: Build Images and Test Services
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
      with:
        driver-opts: network=host

    - name: Build backend image
      uses: docker/build-push-action@v5
      with:
        context: ./backend
        file: ./backend/Dockerfile
        push: false
        tags: euro-bakshish-backend:test
        cache-from: type=gha
        cache-to: type=gha,mode=max
        load: true

    - name: Build frontend image
      uses: docker/build-push-action@v5
      with:
        context: ./web
        file: ./web/Dockerfile
        push: false
        tags: euro-bakshish-web:test
        cache-from: type=gha
        cache-to: type=gha,mode=max
        build-args: |
          REACT_APP_API_URL=http://localhost:8000/api
        load: true

    - name: Create environment configuration
      run: |
        cat > backend/.env << EOF
        SECRET_KEY=test-secret-key-for-docker-compose-testing
        DEBUG=True
        ALLOWED_HOSTS=localhost,127.0.0.1,backend
        DB_NAME=euro_bakshish
        DB_USER=postgres
        DB_PASSWORD=postgres
        DB_HOST=db
        DB_PORT=5432
        CORS_ALLOWED_ORIGINS=http://localhost:3000,http://localhost:80,http://localhost
        EOF

    - name: Start Docker Compose services
      run: |
        docker compose up -d
        echo "Services started, waiting for initialization..."

    - name: Wait for database to be ready
      run: |
        echo "Waiting for PostgreSQL to be ready..."
        max_attempts=30
        attempt=0
        until docker compose exec -T db pg_isready -U postgres || [ $attempt -eq $max_attempts ]; do
          echo "Attempt $((++attempt))/$max_attempts - PostgreSQL not ready yet..."
          sleep 2
        done
        if [ $attempt -eq $max_attempts ]; then
          echo "❌ Database failed to become ready"
          docker compose logs db
          exit 1
        fi
        echo "✅ Database is ready"

    - name: Wait for backend to be healthy
      run: |
        echo "Waiting for backend API to respond..."
        max_attempts=30
        attempt=0
        until curl -f http://localhost:8000/api/ 2>/dev/null || [ $attempt -eq $max_attempts ]; do
          echo "Attempt $((++attempt))/$max_attempts - Backend not ready yet..."
          sleep 3
        done
        if [ $attempt -eq $max_attempts ]; then
          echo "❌ Backend failed to start"
          docker compose logs backend
          exit 1
        fi
        echo "✅ Backend is healthy"

    - name: Wait for frontend to be healthy
      run: |
        echo "Waiting for frontend to respond..."
        max_attempts=20
        attempt=0
        until curl -f http://localhost/ 2>/dev/null || [ $attempt -eq $max_attempts ]; do
          echo "Attempt $((++attempt))/$max_attempts - Frontend not ready yet..."
          sleep 3
        done
        if [ $attempt -eq $max_attempts ]; then
          echo "❌ Frontend failed to start"
          docker compose logs web
          exit 1
        fi
        echo "✅ Frontend is healthy"

    - name: Display running containers
      run: |
        echo "=== Container Status ==="
        docker compose ps

    - name: Test database connectivity
      run: |
        echo "Testing database connectivity..."
        docker compose exec -T db psql -U postgres -d euro_bakshish -c "SELECT version();"
        echo "✅ Database connectivity verified"

    - name: Run backend tests
      run: |
        echo "Running backend unit tests..."
        docker compose exec -T backend pytest -v --tb=short
        echo "✅ Backend tests passed"

    - name: Test API endpoints
      run: |
        echo "Testing key API endpoints..."
        
        # Test API root
        echo "Testing API root endpoint..."
        curl -f http://localhost:8000/api/ || exit 1
        
        # Test API docs
        echo "Testing API documentation..."
        curl -f http://localhost:8000/api/docs/ || exit 1
        
        echo "✅ API endpoints verified"

    - name: Show container logs on failure
      if: failure()
      run: |
        echo ""
        echo "=========================================="
        echo "Container Status:"
        echo "=========================================="
        docker compose ps
        echo ""
        echo "=========================================="
        echo "Backend Logs:"
        echo "=========================================="
        docker compose logs --tail=100 backend
        echo ""
        echo "=========================================="
        echo "Database Logs:"
        echo "=========================================="
        docker compose logs --tail=50 db
        echo ""
        echo "=========================================="
        echo "Frontend Logs:"
        echo "=========================================="
        docker compose logs --tail=50 web

    - name: Cleanup Docker resources
      if: always()
      run: |
        echo "Stopping and removing containers..."
        docker compose down -v
        echo "✅ Cleanup completed"
